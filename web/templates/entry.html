{% extends "base.html" %}

{% block title %}Entry Camera | Smart Attendance{% endblock %}

{% block content %}
<section
    class="container"
    id="entryRoot"
    data-scan-interval-ms="{{ (settings.recognition_interval_seconds * 1000) | int }}"
    data-default-run-interval="{{ settings.run_interval_seconds }}"
    data-default-session-duration="{{ settings.session_duration_minutes }}"
    data-default-motion-threshold="{{ settings.fair_motion_threshold }}"
    data-default-minimum-duration="{{ settings.minimum_duration_minutes }}"
>
    <div class="page-head">
        <h1>Entry Camera</h1>
        <p>Real-time facial recognition for entry attendance tracking.</p>
    </div>

    <div class="split-layout camera-layout">
        <section class="card">
            <div class="card-head">
                <h2>Live Feed</h2>
                <span class="live-pill" id="liveStatus">Idle</span>
            </div>
            <div class="card-body">
                <div class="camera-panel large" id="cameraPanel">
                    <video id="liveVideo" autoplay playsinline muted></video>
                    <canvas id="frameCanvas" hidden></canvas>
                    <div class="liveness-badge checking" id="livenessBadge" hidden>
                        🔍 Checking Liveness...
                    </div>
                </div>

                <div class="toolbar">
                    <button id="startCameraBtn" class="btn btn-primary">Start Camera</button>
                    <button id="stopCameraBtn" class="btn btn-secondary" disabled>Stop Camera</button>
                    <button id="scanOnceBtn" class="btn btn-secondary" disabled>Scan Once</button>
                    <button id="toggleMonitorBtn" class="btn btn-ghost" disabled>Start Auto Monitor</button>
                </div>

                <div id="resultBox" class="result-box" hidden>
                    <h3>Recognition Result</h3>
                    <div id="resultContent"></div>
                </div>
            </div>
        </section>

        <aside class="stack">
            <section class="card">
                <div class="card-head">
                    <h2>Teacher Controls</h2>
                </div>
                <div class="card-body">
                    <label class="field">
                        <span>Active Subject</span>
                        <select id="activeSubject" class="input">
                            {% for subject in settings.subject_options %}
                            <option value="{{ subject }}" {% if settings.active_subject == subject %}selected{% endif %}>{{ subject }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="field">
                        <span>Camera Policy</span>
                        <select id="cameraPolicy" class="input">
                            <option value="on_demand" {% if settings.camera_policy == 'on_demand' %}selected{% endif %}>On-demand scan</option>
                            <option value="always_on" {% if settings.camera_policy == 'always_on' %}selected{% endif %}>Always on monitoring</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Run Mode</span>
                        <select id="cameraRunMode" class="input">
                            <option value="once" {% if settings.camera_run_mode == 'once' %}selected{% endif %}>Run Once and Record</option>
                            <option value="session" {% if settings.camera_run_mode == 'session' %}selected{% endif %}>Class Session (Till Class Over)</option>
                            <option value="interval" {% if settings.camera_run_mode == 'interval' %}selected{% endif %}>Timed Fair Check</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Session Duration (minutes)</span>
                        <input id="sessionDuration" type="number" min="1" class="input" value="{{ settings.session_duration_minutes }}">
                    </label>
                    <label class="field">
                        <span>Interval Check (seconds)</span>
                        <input id="runInterval" type="number" min="3" class="input" value="{{ settings.run_interval_seconds }}">
                    </label>
                    <label class="field">
                        <span>Fair Motion Threshold (0-1)</span>
                        <input id="motionThreshold" type="number" min="0" max="1" step="0.001" class="input" value="{{ settings.fair_motion_threshold }}">
                    </label>
                    <label class="field">
                        <span>Minimum Duration for Present (minutes)</span>
                        <input id="minimumDuration" type="number" min="1" class="input" value="{{ settings.minimum_duration_minutes }}">
                    </label>
                    <label class="toggle">
                        <input id="useYolo" type="checkbox" {% if settings.use_yolo %}checked{% endif %} {% if not settings.yolo_supported %}disabled{% endif %}>
                        <span>Use YOLO Detector</span>
                    </label>
                    <p class="meta-note">
                        {% if settings.yolo_supported %}
                            YOLO Status: <strong style="color: var(--success);">Available</strong>
                        {% else %}
                            YOLO Status: <strong style="color: var(--warning);">Not Available</strong>
                        {% endif %}
                    </p>
                    <label class="toggle">
                        <input id="useLivenessDetection" type="checkbox" checked>
                        <span>Enable Liveness Detection</span>
                    </label>
                    <p class="meta-note" id="livenessStatus">
                        Liveness Status: <strong id="livenessStatusText" style="color: var(--info);">Loading...</strong>
                    </p>
                    <p class="meta-note">Minimum duration determines PRESENT/ABSENT status. If time spent is below minimum, student is marked ABSENT.</p>
                    <p class="meta-note">Run Once = single click, Session = continuous monitoring until timer ends, Timed Fair Check = periodic recognition with movement check.</p>
                </div>
            </section>

            <section class="card">
                <div class="card-head">
                    <h2>Recent Entries</h2>
                </div>
                <div class="card-body">
                    <div id="recentEntriesList" class="activity-list"></div>
                </div>
            </section>
        </aside>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/liveness_detector.js') }}"></script>
<script src="{{ url_for('static', filename='js/entry.js') }}"></script>
{% endblock %}
